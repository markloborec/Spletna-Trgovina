<div class="backdrop" (click)="closeModal()" (keydown)="onKeydown($event)" tabindex="-1">
    <div class="modal" role="dialog" aria-modal="true" [attr.aria-labelledby]="titleId" [attr.aria-describedby]="descId"
        (click)="$event.stopPropagation()">
        <p class="sr-only" [id]="descId">
            Okno s podrobnostmi izdelka. Za zapiranje pritisni Escape. Premika≈° se lahko s tipko Tab.
        </p>

        <button #closeBtn class="close-btn" type="button" (click)="closeModal()" aria-label="Zapri" title="Zapri">
            ‚úï
        </button>

        <div class="header">
            <h2 #dialogTitle class="title" [id]="titleId" tabindex="-1">
                {{ (productFull ?? product)?.name }}
            </h2>

            <div class="meta">
                <span class="chip" *ngIf="(productFull ?? product)?.type as t">
                    Tip:
                    <ng-container [ngSwitch]="t">
                        <span *ngSwitchCase="'cycles'">Kolo</span>
                        <span *ngSwitchCase="'equipment'">Oprema</span>
                        <span *ngSwitchCase="'clothing'">Oblaƒçila</span>
                        <span *ngSwitchDefault>{{ t }}</span>
                    </ng-container>
                </span>

                <span class="chip" *ngIf="(productFull ?? product)?.isAvailable === false">Ni na zalogi</span>
                <span class="chip chip-ok" *ngIf="(productFull ?? product)?.isAvailable !== false">Na zalogi</span>
            </div>
        </div>

        <div class="image-wrap">
            <img *ngIf="(productFull ?? product)?.imageUrl" [src]="(productFull ?? product).imageUrl"
                [alt]="(productFull ?? product)?.name" class="product-image" loading="lazy" />
            <div class="no-image" *ngIf="!(productFull ?? product)?.imageUrl">
                <div class="emoji">üõçÔ∏è</div>
                <div>Ni slike</div>
            </div>
        </div>

        <div class="price">
            <div class="price-label">Cena</div>
            <div class="price-value">
                {{ (productFull ?? product)?.price | currency:'EUR':'symbol':'1.2-2':'sl-SI' }}
            </div>
        </div>

        <div class="section">
            <div class="row">
                <span class="label">Kratki opis</span>
                <span class="value">{{ (productFull ?? product)?.shortDescription || '‚Äî' }}</span>
            </div>

            <div class="row">
                <span class="label">Dolgi opis</span>
                <span class="value">{{ (productFull ?? product)?.longDescription || '‚Äî' }}</span>
            </div>

            <div class="row">
                <span class="label">Garancija</span>
                <span class="value">
                    {{ (productFull ?? product)?.warrantyMonths ?? '‚Äî' }}
                    <ng-container *ngIf="(productFull ?? product)?.warrantyMonths != null"> mesecev</ng-container>
                </span>
            </div>

            <div class="row">
                <span class="label">Uradna stran</span>
                <span class="value">
                    <a *ngIf="(productFull ?? product)?.officialProductSite; else noSite"
                        [href]="(productFull ?? product).officialProductSite" target="_blank" rel="noopener noreferrer"
                        (click)="$event.stopPropagation()" (dblclick)="$event.stopPropagation()">
                        Odpri uradno stran
                    </a>
                    <ng-template #noSite>‚Äî</ng-template>
                </span>
            </div>

            <ng-container [ngSwitch]="(productFull ?? product)?.type">
                <ng-container *ngSwitchCase="'cycles'">
                    <div class="row">
                        <span class="label">Velikost obroƒçev</span>
                        <span class="value">{{ (productFull ?? product)?.wheelSize ?? '‚Äî' }}"</span>
                    </div>
                    <div class="row">
                        <span class="label">Okvir</span>
                        <span class="value">{{ (productFull ?? product)?.frameMaterial ?? '‚Äî' }}</span>
                    </div>
                    <div class="row">
                        <span class="label">Prestav</span>
                        <span class="value">{{ (productFull ?? product)?.gearCount ?? '‚Äî' }}</span>
                    </div>
                </ng-container>

                <ng-container *ngSwitchCase="'clothing'">
                    <div class="row">
                        <span class="label">Velikost</span>
                        <span class="value">{{ (productFull ?? product)?.size || '‚Äî' }}</span>
                    </div>
                    <div class="row">
                        <span class="label">Spol</span>
                        <span class="value">
                            <ng-container *ngIf="(productFull ?? product)?.gender as g; else genderDash">
                                <ng-container [ngSwitch]="g">
                                    <span *ngSwitchCase="'male'">mo≈°ki</span>
                                    <span *ngSwitchCase="'female'">≈æenski</span>
                                    <span *ngSwitchCase="'unisex'">unisex</span>
                                    <span *ngSwitchDefault>{{ g }}</span>
                                </ng-container>
                            </ng-container>
                            <ng-template #genderDash>‚Äî</ng-template>
                        </span>
                    </div>
                    <div class="row">
                        <span class="label">Material</span>
                        <span class="value">{{ (productFull ?? product)?.material || '‚Äî' }}</span>
                    </div>
                    <div class="row">
                        <span class="label">Barva</span>
                        <span class="value">{{ (productFull ?? product)?.color || '‚Äî' }}</span>
                    </div>
                </ng-container>

                <ng-container *ngSwitchCase="'equipment'">
                    <div class="row">
                        <span class="label">Znamka</span>
                        <span class="value">{{ (productFull ?? product)?.brand || '‚Äî' }}</span>
                    </div>
                    <div class="row">
                        <span class="label">Material</span>
                        <span class="value">{{ (productFull ?? product)?.material || '‚Äî' }}</span>
                    </div>
                    <div class="row">
                        <span class="label">Te≈æa</span>
                        <span class="value">
                            <ng-container *ngIf="(productFull ?? product)?.weight != null; else wDash">
                                {{ (productFull ?? product)?.weight }} g
                            </ng-container>
                            <ng-template #wDash>‚Äî</ng-template>
                        </span>
                    </div>

                    <div class="row">
                        <span class="label">Kompatibilnost</span>
                        <span class="value">
                            <ng-container *ngIf="(productFull ?? product)?.compatibility?.length; else compDash">
                                <ul class="list">
                                    <li *ngFor="let c of (productFull ?? product).compatibility">{{ c }}</li>
                                </ul>
                            </ng-container>
                            <ng-template #compDash>‚Äî</ng-template>
                        </span>
                    </div>
                </ng-container>
            </ng-container>
        </div>

        <div class="section reviews">
            <div class="reviews-header">
                <div class="reviews-title">Ocene in mnenja</div>

                <div class="rating-summary">
                    <div class="stars" aria-label="povpreƒçna ocena">
                        <span class="star" *ngFor="let s of [1,2,3,4,5]" [class.filled]="s <= avgRating">‚òÖ</span>
                    </div>
                    <div class="rating-numbers">
                        <span class="avg">{{ avgRating | number:'1.1-1' }}</span>
                        <span class="count">({{ ratingCount }} ocen)</span>
                    </div>
                </div>
            </div>

            <div class="reviews-body">
                <div class="reviews-loading" *ngIf="loadingReviews">Nalagam mnenja‚Ä¶</div>
                <div class="reviews-error" *ngIf="!loadingReviews && reviewsError">{{ reviewsError }}</div>

                <div class="reviews-empty"
                    *ngIf="!loadingReviews && !reviewsError && (!reviews || reviews.length === 0)">
                    Ta izdelek ≈°e nima mnenj.
                </div>

                <div class="review-card" *ngFor="let r of reviews">
                    <div class="review-top">
                        <div class="stars small" aria-label="ocena mnenja">
                            <span class="star" *ngFor="let s of [1,2,3,4,5]" [class.filled]="s <= r.rating">‚òÖ</span>
                        </div>
                        <div class="date">{{ r.createdAt | date:'dd.MM.yyyy' }}</div>
                    </div>

                    <div class="comment" *ngIf="r.comment; else noComment">{{ r.comment }}</div>
                    <ng-template #noComment>
                        <div class="comment muted">‚Äî</div>
                    </ng-template>
                </div>
            </div>
        </div>
    </div>
</div>